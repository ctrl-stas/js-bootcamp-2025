<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JS Playground — тренажёр JavaScript</title>
    <style>
      :root {
        --bg: #0f1220;
        --panel: #171a2b;
        --panel-2: #1e2240;
        --ink: #e9ecff;
        --muted: #b7c0ff;
        --accent: #6ea3ff;
        --accent-2: #7ee0d2;
        --warn: #ffd479;
        --ok: #9dffa8;
        --danger: #ff7a7a;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--ink);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        line-height: 1.5;
      }
      a {
        color: var(--accent);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px;
      }
      header {
        background: linear-gradient(135deg, var(--panel), var(--panel-2));
        border-radius: 14px;
        padding: 16px 18px;
        margin: 8px 0 16px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 22px;
      }
      .muted {
        color: var(--muted);
      }
      .layout {
        display: grid;
        gap: 14px;
      }
      @media (min-width: 900px) {
        .layout {
          grid-template-columns: 1.15fr 0.85fr;
        }
      }
      .panel {
        background: var(--panel);
        border: 1px solid #2b2f53;
        border-radius: 12px;
        padding: 12px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 6px 0 8px;
      }
      .btn {
        appearance: none;
        border: 1px solid #2b2f53;
        background: #1a1e36;
        color: #dfe6ff;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .btn:hover {
        border-color: #4150a8;
      }
      .btn.warn {
        border-color: #6b5a2a;
        background: #2a2618;
        color: #ffdba0;
      }
      .btn.danger {
        border-color: #5a2a2a;
        background: #2a1818;
        color: #ffb3b3;
      }
      .tag {
        display: inline-block;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #33407a;
        background: #1a1f3f;
        color: #cce;
        margin-right: 6px;
      }
      textarea {
        width: 100%;
        min-height: 360px;
        border-radius: 10px;
        border: 1px solid #2b2f53;
        background: #111527;
        color: #e7ebff;
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 14px;
        line-height: 1.4;
      }
      .console {
        background: #0c1020;
        border: 1px solid #2b2f53;
        border-radius: 10px;
        min-height: 200px;
        max-height: 460px;
        overflow: auto;
        padding: 10px;
        font-family: ui-monospace, Consolas, monospace;
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .pill {
        display: inline-block;
        border: 1px solid #33407a;
        background: #1a1f3f;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        color: #cce;
      }
      .line {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 4px 0;
      }
      .log .prefix {
        color: #9bb8ff;
      }
      .info .prefix {
        color: #7ee0d2;
      }
      .warn .prefix {
        color: #ffd479;
      }
      .error .prefix {
        color: #ff7a7a;
      }
      .ts {
        opacity: 0.6;
        font-size: 11px;
        margin-right: 6px;
      }
      .footer {
        margin: 14px 0 6px;
        text-align: center;
        color: #9aa6ff;
      }
      code {
        background: #111527;
        color: #d6e0ff;
        border: 1px solid #2b2f53;
        border-radius: 6px;
        padding: 0 6px;
      }
      details {
        background: #13162a;
        border: 1px solid #2b2f53;
        border-radius: 10px;
        padding: 10px;
        margin-top: 10px;
      }
      summary {
        cursor: pointer;
      }
      .hint {
        font-size: 12px;
        color: #9fb1ff;
        margin: 8px 0 -2px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>JS Playground — тренажёр JavaScript</h1>
        <div class="row">
          <span class="tag">Запуск: Ctrl/Cmd + Enter</span>
          <span class="tag">Тайминг выполнения</span>
          <span class="tag">Helpers: assert, test, sleep</span>
        </div>
        <p class="muted">
          Есть два способа писать код: 1. в редакторе ниже и нажимать
          “Запустить”; 2. в специальном INLINE‑блоке прямо внутри HTML
          (обозначен большими маркерами), и запускать его отдельной кнопкой.
        </p>
      </header>

      <div class="layout">
        <section class="panel">
          <h2 style="margin: 4px 0 6px">Редактор кода</h2>
          <div class="toolbar">
            <button class="btn" id="runBtn">Запустить (Ctrl/Cmd+Enter)</button>
            <button class="btn" id="clearBtn">Очистить консоль</button>
            <button class="btn" id="saveBtn">Сохранить</button>
            <button class="btn warn" id="resetBtn">Сбросить к шаблону</button>
            <span class="pill" id="timePill">Время: —</span>
          </div>
          <textarea id="editor" spellcheck="false"></textarea>

          <details>
            <summary>Подсказки и хелперы</summary>
            <div class="hint">Доступно в рантайме:</div>
            <ul>
              <li>
                <code>assert(cond, msg)</code> — выбрасывает ошибку, если cond
                ложен.
              </li>
              <li>
                <code>test(name, fn)</code> — запускает fn и пишет PASS/FAIL в
                консоль.
              </li>
              <li>
                <code>await sleep(ms)</code> — задержка в мс (поддерживается
                top‑level await).
              </li>
            </ul>
            <div class="hint">Полезно:</div>
            <ul>
              <li>
                <code>console.log/info/warn/error</code> — попадают в панель
                консоли справа.
              </li>
              <li>
                Код выполняется как асинхронный модуль, можно использовать
                <code>await</code> на верхнем уровне.
              </li>
            </ul>
          </details>
        </section>

        <aside class="panel">
          <h2 style="margin: 4px 0 6px">Консоль</h2>
          <div id="console" class="console" aria-live="polite"></div>
          <div class="toolbar" style="margin-top: 8px">
            <button class="btn" id="runInlineBtn">Запустить INLINE</button>
            <button class="btn" id="copyLogsBtn">Скопировать логи</button>
          </div>

          <details>
            <summary>Небольшие тренировочные идеи</summary>
            <ul style="margin-top: 6px">
              <li>Напишите <code>capitalize(str)</code> и протестируйте её.</li>
              <li>
                Сделайте <code>debounce(fn, ms)</code> и проверьте через
                <code>sleep</code>.
              </li>
              <li>
                Реализуйте <code>range(start,end,step)</code> генератор и
                посчитайте сумму.
              </li>
              <li>
                Сымитируйте API: <code>mockFetch(url, {delay})</code> с шансом
                ошибки, добавьте <code>retry</code>.
              </li>
            </ul>
          </details>
        </aside>
      </div>

      <!-- ============================
       МЕСТО ДЛЯ ВАШИХ СКРИПТОВ (INLINE)
       Как пользоваться:
       1) Пишите код внутри этого блока (тип text/plain — не выполняется автоматически).
       2) Нажмите кнопку “Запустить INLINE” над консолью.
       3) Результаты будут в панели “Консоль”.
       Доступны: console, assert, test, sleep, performance.
       ============================ -->
      <script id="practice-inline" type="text/plain">
        // Пример (можете удалить):
        console.log('Привет из INLINE-блока!');
        test('Сложение работает', () => {
          const sum = (a,b)=>a+b;
          assert(sum(2,2)===4, '2+2 должно быть 4');
        });
        await sleep(200);
        console.info('Готово.');
      </script>
      <!-- ===== КОНЕЦ МЕСТА ДЛЯ ВАШИХ СКРИПТОВ (INLINE) ===== -->

      <footer class="footer">
        Удачной практики! Код редактора сохраняется в браузере автоматически.
      </footer>
    </div>

    <script>
      (function(){
        const lsKey = 'js-playground-code-v1';

        // DOM elements
        const editor = document.getElementById('editor');
        const runBtn = document.getElementById('runBtn');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');
        const timePill = document.getElementById('timePill');
        const consoleEl = document.getElementById('console');
        const runInlineBtn = document.getElementById('runInlineBtn');
        const copyLogsBtn = document.getElementById('copyLogsBtn');

        // Default template
        const template = `// Добро пожаловать в JS Playground!
      // Подсказка: жмите Ctrl/Cmd+Enter для запуска. Доступны: console, assert, test, sleep.
      // Пример:
      console.log('Hello from editor!');
      function capitalize(str){ return (str ?? '').toString().trim().replace(/^./, c => c.toUpperCase()); }

      test('capitalize: базовый', () => {
        assert(capitalize('js') === 'Js', 'ожидали Js');
      });

      await sleep(150);
      console.info('Готово! Время см. над редактором.');
      `;

        // Load saved code
        const saved = localStorage.getItem(lsKey);
        editor.value = saved ? saved : template;

        // Console rendering
        let logsBuffer = [];
        function ts()
        { return new Date().toLocaleTimeString(); }
        function appendLine(type, args){
          const line = document.createElement('div');
          line.className = 'line ' + type;
          const time = document.createElement('span');
          time.className = 'ts';
          time.textContent = [$ts()];
          const prefix = document.createElement('span');
          prefix.className = 'prefix';
          prefix.textContent = type.toUpperCase() + ': ';
          const content = document.createElement('span');
          try {
            const formatted = Array.from(args).map(v => {
              if (typeof v === 'string') return v;
              if (v instanceof Error) return v.stack || (v.name + ': ' + v.message);
              try { return JSON.stringify(v, null, 2); } catch { return String(v); }
            }).join(' ');
            content.textContent = formatted;
            logsBuffer.push(${time.textContent} ${type}: ${formatted}); } catch(e){
            content.textContent = Array.from(args).join(' ');
          }
          line.append(time, prefix, content);
          consoleEl.appendChild(line);
          consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole(){
          consoleEl.innerHTML = '';
          logsBuffer = [];
        }

        // Helper APIs for user code
        function makeSandboxConsole(){
          return {
            log: (...a)=>appendLine('log', a),
            info: (...a)=>appendLine('info', a),
            warn: (...a)=>appendLine('warn', a),
            error: (...a)=>appendLine('error', a),
          };
        }
        function assert(cond, msg='Assertion failed'){
          if(!cond){ throw new Error(msg); }
        }
        async function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }
        async function test(name, fn){
          const start = performance.now();
          try{
            const r = fn();
            if (r && typeof r.then === 'function') await r;
            const dt = (performance.now()-start).toFixed(1);
            appendLine('info',[PASS (${dt}ms), name]);
          }catch(err){
            const dt = (performance.now()-start).toFixed(1);
            appendLine('error',[FAIL (${dt}ms), name, err]);
          }
        }

        async function run(code){
          clearTiming();
          const start = performance.now();
          const sandboxConsole = makeSandboxConsole();
          const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
          try{
            await new AsyncFunction('console','assert','test','sleep','performance', "use strict";\n${code}\n)(sandboxConsole, assert, test, sleep, performance);
            const dt = (performance.now()-start).toFixed(1);
            timePill.textContent = Время: ${dt} ms;
          }catch(err){
            appendLine('error', [err]);
            const dt = (performance.now()-start).toFixed(1);
            timePill.textContent = Время: ${dt} ms (с ошибкой);
          }
        }

        function clearTiming(){
          timePill.textContent = 'Время: —';
        }

        // Actions
        runBtn.addEventListener('click', async ()=>{
          clearConsole();
          await run(editor.value);
        });
        clearBtn.addEventListener('click', ()=>clearConsole());
        saveBtn.addEventListener('click', ()=>{
          localStorage.setItem(lsKey, editor.value);
          appendLine('info',['Сохранено в браузер (localStorage).']);
        });
        resetBtn.addEventListener('click', ()=>{
          if(confirm('Сбросить код к шаблону? Текущее содержимое будет потеряно.')){
            editor.value = template;
            localStorage.setItem(lsKey, editor.value);
            appendLine('warn',['Код сброшен к шаблону.']);
          }
        });
        copyLogsBtn.addEventListener('click', async ()=>{
          try{
            await navigator.clipboard.writeText(logsBuffer.join('\n'));
            appendLine('info',['Логи скопированы в буфер обмена.']);
          }catch(e){
            appendLine('warn',['Не удалось скопировать логи: ', e]);
          }
        });

        // Keyboard Run
        editor.addEventListener('keydown', (e)=>{
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
            e.preventDefault();
            runBtn.click();
          }
        });

        // Run INLINE block
        runInlineBtn.addEventListener('click', async ()=>{
          const node = document.getElementById('practice-inline');
          if(!node){ appendLine('warn',['INLINE-блок не найден']); return; }
          clearConsole(); await run(String(node.textContent || ''));
        });

      })();
    </script>
  </body>
</html>
